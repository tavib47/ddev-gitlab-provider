# GitLab Package Registry provider for DDEV
#
# Pull database and files from GitLab Package Registry.
#
# Required environment variables (set in .ddev/.env):
#   GITLAB_PROJECT_ID - Your GitLab project ID
#   GITLAB_TOKEN - Personal Access Token with 'read_api' scope
#
# Optional environment variables:
#   GITLAB_API_URL - GitLab API URL (default: https://gitlab.com/api/v4)
#   DB_DUMP_PACKAGE_NAME - Package name for database (default: database)
#   DB_DUMP_VERSION - Package version (default: test)
#   FILES_DUMP_PACKAGE_NAME - Package name for files (default: drupal-files)
#   FILES_DUMP_VERSION - Package version (default: test)
#
# Usage:
#   ddev pull gitlab

environment_variables:
  gitlab_api_url: ${GITLAB_API_URL:-https://gitlab.com/api/v4}
  gitlab_project_id: ${GITLAB_PROJECT_ID:-}
  gitlab_token: ${GITLAB_TOKEN:-}
  db_package_name: ${DB_DUMP_PACKAGE_NAME:-database}
  db_version: ${DB_DUMP_VERSION:-test}
  files_package_name: ${FILES_DUMP_PACKAGE_NAME:-drupal-files}
  files_version: ${FILES_DUMP_VERSION:-test}

auth_command:
  command: |
    set -eu -o pipefail
    if [ -z "${gitlab_project_id:-}" ]; then
      echo "Error: GITLAB_PROJECT_ID is not set"
      echo "Set it in .ddev/.env or export it in your shell"
      exit 1
    fi
    if [ -z "${gitlab_token:-}" ]; then
      echo "Error: GITLAB_TOKEN is not set"
      echo "Create a token with 'read_api' scope at https://gitlab.com/-/user_settings/personal_access_tokens"
      echo "Then set it in .ddev/.env or export it in your shell"
      exit 1
    fi
  service: host

db_pull_command:
  command: |
    set -eu -o pipefail
    mkdir -p .ddev/.downloads
    DOWNLOAD_URL="${gitlab_api_url}/projects/${gitlab_project_id}/packages/generic/${db_package_name}/${db_version}/dump.sql.gz"
    echo "Downloading database from GitLab Package Registry..."
    echo "URL: ${DOWNLOAD_URL}"
    curl --fail --silent --show-error \
      --header "PRIVATE-TOKEN: ${gitlab_token}" \
      --output .ddev/.downloads/db.sql.gz \
      "${DOWNLOAD_URL}"
    echo "Database download complete."
  service: host

files_pull_command:
  command: |
    set -eu -o pipefail
    mkdir -p .ddev/.downloads/files

    # Download public files
    PUBLIC_URL="${gitlab_api_url}/projects/${gitlab_project_id}/packages/generic/${files_package_name}/${files_version}/public-files.tar.gz"
    echo "Downloading public files from GitLab Package Registry..."
    echo "URL: ${PUBLIC_URL}"
    curl --fail --silent --show-error \
      --header "PRIVATE-TOKEN: ${gitlab_token}" \
      --output .ddev/.downloads/public-files.tar.gz \
      "${PUBLIC_URL}"

    echo "Extracting public files..."
    tar -xzf .ddev/.downloads/public-files.tar.gz -C .ddev/.downloads/files/ --strip-components=5 2>/dev/null || \
    tar -xzf .ddev/.downloads/public-files.tar.gz -C .ddev/.downloads/files/

    echo "Files download complete."
  service: host

# Uncomment to also pull private files
# files_pull_command:
#   command: |
#     set -eu -o pipefail
#     mkdir -p .ddev/.downloads/files
#
#     # Download public files
#     PUBLIC_URL="${gitlab_api_url}/projects/${gitlab_project_id}/packages/generic/${files_package_name}/${files_version}/public-files.tar.gz"
#     echo "Downloading public files..."
#     curl --fail --silent --show-error \
#       --header "PRIVATE-TOKEN: ${gitlab_token}" \
#       --output .ddev/.downloads/public-files.tar.gz \
#       "${PUBLIC_URL}"
#     tar -xzf .ddev/.downloads/public-files.tar.gz -C .ddev/.downloads/files/ --strip-components=5
#
#     # Download private files
#     PRIVATE_URL="${gitlab_api_url}/projects/${gitlab_project_id}/packages/generic/${files_package_name}/${files_version}/private-files.tar.gz"
#     echo "Downloading private files..."
#     curl --fail --silent --show-error \
#       --header "PRIVATE-TOKEN: ${gitlab_token}" \
#       --output .ddev/.downloads/private-files.tar.gz \
#       "${PRIVATE_URL}"
#     mkdir -p private
#     tar -xzf .ddev/.downloads/private-files.tar.gz -C private/ --strip-components=4
#
#     echo "Files download complete."
#   service: host
