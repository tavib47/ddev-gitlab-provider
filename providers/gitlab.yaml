# GitLab Package Registry provider for DDEV
#
# Pull database and files from GitLab Package Registry.
#
# Required environment variables (set in .ddev/.env):
#   GITLAB_PROJECT_ID - Your GitLab project ID
#   GITLAB_TOKEN - Personal Access Token with 'read_api' scope
#
# Optional environment variables:
#   GITLAB_API_URL - GitLab API URL (default: https://gitlab.com/api/v4)
#
#   Database:
#     DB_DUMP_PACKAGE_NAME - Package name (default: database)
#     DB_DUMP_VERSION - Package version (default: test)
#     DB_DUMP_FILENAME - Filename (default: dump.sql.gz)
#
#   Public files:
#     PUBLIC_FILES_PACKAGE_NAME - Package name (default: drupal-files)
#     PUBLIC_FILES_VERSION - Package version (default: test)
#     PUBLIC_FILES_FILENAME - Filename (default: public-files.tar.gz)
#
#   Private files:
#     PRIVATE_FILES_PACKAGE_NAME - Package name (default: drupal-files)
#     PRIVATE_FILES_VERSION - Package version (default: test)
#     PRIVATE_FILES_FILENAME - Filename (default: private-files.tar.gz)
#     PRIVATE_FILES_PATH - Destination path (default: private)
#     PULL_PRIVATE_FILES - Set to "true" to enable (default: false)
#
# Usage:
#   ddev pull gitlab

auth_command:
  command: |
    set -eu -o pipefail
    [ -f .env ] && source .env
    [ -f .ddev/.env ] && source .ddev/.env
    if [ -z "${GITLAB_PROJECT_ID:-}" ]; then
      echo "Error: GITLAB_PROJECT_ID is not set"
      echo "Set it in .ddev/.env or export it in your shell"
      exit 1
    fi
    if [ -z "${GITLAB_TOKEN:-}" ]; then
      echo "Error: GITLAB_TOKEN is not set"
      echo "Create a token with 'read_api' scope at https://gitlab.com/-/user_settings/personal_access_tokens"
      echo "Then set it in .ddev/.env or export it in your shell"
      exit 1
    fi
  service: host

db_pull_command:
  command: |
    set -eu -o pipefail
    [ -f .env ] && source .env
    [ -f .ddev/.env ] && source .ddev/.env
    GITLAB_API_URL="${GITLAB_API_URL:-https://gitlab.com/api/v4}"
    DB_DUMP_PACKAGE_NAME="${DB_DUMP_PACKAGE_NAME:-database}"
    DB_DUMP_VERSION="${DB_DUMP_VERSION:-test}"
    DB_DUMP_FILENAME="${DB_DUMP_FILENAME:-dump.sql.gz}"

    mkdir -p .ddev/.downloads
    DOWNLOAD_URL="${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/packages/generic/${DB_DUMP_PACKAGE_NAME}/${DB_DUMP_VERSION}/${DB_DUMP_FILENAME}"
    echo "Downloading database from GitLab Package Registry..."
    echo "URL: ${DOWNLOAD_URL}"
    curl --fail --silent --show-error \
      --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
      --output .ddev/.downloads/db.sql.gz \
      "${DOWNLOAD_URL}"
    echo "Database download complete."
  service: host

files_pull_command:
  command: |
    set -eu -o pipefail
    [ -f .env ] && source .env
    [ -f .ddev/.env ] && source .ddev/.env
    GITLAB_API_URL="${GITLAB_API_URL:-https://gitlab.com/api/v4}"
    PUBLIC_FILES_PACKAGE_NAME="${PUBLIC_FILES_PACKAGE_NAME:-drupal-files}"
    PUBLIC_FILES_VERSION="${PUBLIC_FILES_VERSION:-test}"
    PUBLIC_FILES_FILENAME="${PUBLIC_FILES_FILENAME:-public-files.tar.gz}"
    PRIVATE_FILES_PACKAGE_NAME="${PRIVATE_FILES_PACKAGE_NAME:-drupal-files}"
    PRIVATE_FILES_VERSION="${PRIVATE_FILES_VERSION:-test}"
    PRIVATE_FILES_FILENAME="${PRIVATE_FILES_FILENAME:-private-files.tar.gz}"
    PRIVATE_FILES_PATH="${PRIVATE_FILES_PATH:-private}"
    PULL_PRIVATE_FILES="${PULL_PRIVATE_FILES:-false}"

    mkdir -p .ddev/.downloads/files

    # Download public files
    PUBLIC_URL="${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/packages/generic/${PUBLIC_FILES_PACKAGE_NAME}/${PUBLIC_FILES_VERSION}/${PUBLIC_FILES_FILENAME}"
    echo "Downloading public files from GitLab Package Registry..."
    echo "URL: ${PUBLIC_URL}"
    curl --fail --silent --show-error \
      --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
      --output .ddev/.downloads/public-files.tar.gz \
      "${PUBLIC_URL}"

    echo "Extracting public files..."
    tar -xzf .ddev/.downloads/public-files.tar.gz -C .ddev/.downloads/files/ --strip-components=5 2>/dev/null || \
    tar -xzf .ddev/.downloads/public-files.tar.gz -C .ddev/.downloads/files/

    # Download private files if enabled
    if [ "${PULL_PRIVATE_FILES}" = "true" ]; then
      PRIVATE_URL="${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/packages/generic/${PRIVATE_FILES_PACKAGE_NAME}/${PRIVATE_FILES_VERSION}/${PRIVATE_FILES_FILENAME}"
      echo "Downloading private files from GitLab Package Registry..."
      echo "URL: ${PRIVATE_URL}"
      curl --fail --silent --show-error \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --output .ddev/.downloads/private-files.tar.gz \
        "${PRIVATE_URL}"

      echo "Extracting private files to ${PRIVATE_FILES_PATH}..."
      mkdir -p "${PRIVATE_FILES_PATH}"
      tar -xzf .ddev/.downloads/private-files.tar.gz -C "${PRIVATE_FILES_PATH}" --strip-components=4 2>/dev/null || \
      tar -xzf .ddev/.downloads/private-files.tar.gz -C "${PRIVATE_FILES_PATH}"
    fi

    echo "Files download complete."
  service: host
